(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{416:function(s,a,n){"use strict";n.r(a);var e=n(23),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"事务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事务"}},[s._v("#")]),s._v(" 事务")]),s._v(" "),n("h2",{attrs:{id:"事务处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事务处理"}},[s._v("#")]),s._v(" 事务处理")]),s._v(" "),n("p",[s._v("事务处理:利用自动或者手动方式实现事务管理")]),s._v(" "),n("ul",[n("li",[s._v("自动事务处理:系统默认,操作结束直接同步到数据表(事务关闭状态)\n"),n("ul",[n("li",[s._v("系统控制:变量 autocommit(值为ON,自动提交)")])])]),s._v(" "),n("li",[s._v("手动事务处理\n"),n("ul",[n("li",[s._v("开启事务: "),n("code",[s._v("start transaction")])]),s._v(" "),n("li",[s._v("关闭事务:\n"),n("ul",[n("li",[s._v("提交事务: "),n("code",[s._v("commit")])]),s._v(" "),n("li",[s._v("回滚事务: "),n("code",[s._v("rollback")])])])])])]),s._v(" "),n("li",[s._v("事务回滚:在长事务执行中,可以在某个已经成功的节点处设置回滚点,后续回滚的话可以回到某个成功点\n"),n("ul",[n("li",[s._v("设置回滚点: "),n("code",[s._v("savepoint 回滚点名字")])]),s._v(" "),n("li",[s._v("回滚到回滚点: "),n("code",[s._v("rollback to 回滚点名字")])])])])]),s._v(" "),n("blockquote",[n("p",[s._v("步骤")])]),s._v(" "),n("ol",[n("li",[s._v("确定操作需要使用到事务操作")]),s._v(" "),n("li",[s._v("开启事务")]),s._v(" "),n("li",[s._v("执行事务\n"),n("ul",[n("li",[s._v("如果需要回滚点设置 : 设置回滚点")]),s._v(" "),n("li",[s._v("如果需要回滚 : 回滚到回滚点")])])]),s._v(" "),n("li",[s._v("结束事务\n"),n("ul",[n("li",[s._v("成功提交事务 : 同步到数据表,清空事务日志")]),s._v(" "),n("li",[s._v("失败回滚事务 : 清空事务日志")])])])]),s._v(" "),n("h2",{attrs:{id:"事务处理-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事务处理-2"}},[s._v("#")]),s._v(" 事务处理")]),s._v(" "),n("ol",[n("li",[s._v("手动事务:启用事务转账,成功提交事务")])]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 开启事务\nstart transaction;\n\n# Tom扣钱\nupdate t_52 set account = account-1000 where id = 1;\n# Lucy 收钱\nupdate t_52 set account = account-1000 where id = 2;\n\n#提交事务\ncommit;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("手动事务 : 启用事务转账,成功提交事务(回滚点)")])]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 开启事务\nstart transaction;\n#Tom扣钱\nupdate t_52 set account = account -1000 where id= 1;\n#设置回滚点\nsavepoint spl;\n#Lucy收钱\nupdate t_52 set account = account 10000 where id= 2;\n#操作失败回到回滚点\nrollback to sp1;\n# lucy收钱\nupdate t_52 set account account 1000 where id = 2;\n# 提交事务\ncommit;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("ol",{attrs:{start:"3"}},[n("li",[s._v("自动事务")])]),s._v(" "),n("ul",[n("li",[n("p",[s._v("MySQL默认是自动提交事务的:所以事务一旦发生就会立即写入到数据表(不能多个事务一起完成任务)")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("show variables like 'autocommit';\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("关闭自动提交事务(当前设置级别用户级:当前用户档次连接有效)")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("set autocommit = 0;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("手动提交事务")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("insert into t_52 values (null, 'Liu', 1000);\ncommit;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])])]),s._v(" "),n("blockquote",[n("p",[s._v("事务处理要应用到多次写操作组成的大事务中,如金融安全等"),n("br"),s._v("\n事务处理通常都会使用手动控制事务,没必要去修改原本的自动提交的机制,开启所有事务"),n("br"),s._v("\n事务处理的支持是有条件的"),n("br"),s._v("\n存储引擎需要为 InnoDB")])]),s._v(" "),n("h3",{attrs:{id:"事务的特点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事务的特点"}},[s._v("#")]),s._v(" 事务的特点")]),s._v(" "),n("p",[s._v("概念 事务特点:事务处理具有ACID四大特性")]),s._v(" "),n("ul",[n("li",[s._v("原子性( Atomicity):一个事务操作是一个整体,不可拆分,要么都成功,要么都失败")]),s._v(" "),n("li",[s._v("一致性( Consistency):事务执行之前和执行之后都必须处于一致性状态,数据的完整性没有被破坏(事务逻辑的准确性)")]),s._v(" "),n("li",[s._v("隔离性( Isolation):事务操作过程中,其他事务不可见;")]),s._v(" "),n("li",[s._v("持久性( Durability):事务一旦提交,结果不可改变;")]),s._v(" "),n("li",[s._v("事务锁:当—个事务开启时,另外—个事务是不能对当前事务锁占用的数据进行操作的\n"),n("ul",[n("li",[s._v("行锁:当前事务只占用了一行(id精确检索数据),那么其他事务可以操作其他行数据")]),s._v(" "),n("li",[s._v("表锁:当前事务占用了整张表(like扫码整个表),那么其他事务对整张表都不能操作")])])]),s._v(" "),n("li",[s._v('脏读:—个事务在对某个数据进行操作但尚未提交,而另外—个事务读到了这个"历史"数据其实已经被修改')])]),s._v(" "),n("h2",{attrs:{id:"预处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#预处理"}},[s._v("#")]),s._v(" 预处理")]),s._v(" "),n("p",[s._v("预处理: prepare statement,一种预先编译SQL指令的方式(然后命令执行)")]),s._v(" "),n("ul",[n("li",[s._v("预处理不同于直接处理,是将要执行的SQL指令先发送给服务器编译,然后通过指令执行\n"),n("ul",[n("li",[s._v("发送预处理 : prepare 预处理名字from'要执行的SQL指令")]),s._v(" "),n("li",[s._v("执行预处理 : execute 预处理名字")])])]),s._v(" "),n("li",[s._v("预处理管理\n"),n("ul",[n("li",[s._v("预处理属于会话级别:即当前用户当次连接有效(断开会被服务器清理掉)")]),s._v(" "),n("li",[s._v("删除预处理 : "),n("code",[s._v("deallocate I drop prepare 预处理名字")])])])])]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 1、查询学生的SQ指令需要重复执行很多次\n#普通操作\nselect * from t_42;\n#预处理操作:发送预处理\nprepare pl from 'select from t_42';\n#预处理操作:执行预处理\nexecute pl;\n#删除预处理\ndeallocate prepare pl;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("ol",[n("li",[s._v("预处理就是把要执行的结构(SαL指令)提前发送给服务器端,服务器进行编译但不执行,等待执行指令后才执行")]),s._v(" "),n("li",[s._v("预处理的作用\n"),n("ul",[n("li",[s._v("性能优化\n"),n("ul",[n("li",[s._v("效率优化:同样的SαL不用每次都进行编译(编译耗时)\n"),n("ul",[n("li",[s._v("普通处理:每次都需要编译")]),s._v(" "),n("li",[s._v("预处理:编译一次")])])]),s._v(" "),n("li",[s._v("网络传输优化:复杂的SQ指令只需要传输一次\n"),n("ul",[n("li",[s._v("普通处理:每次都需要网络传输SQ指令")]),s._v(" "),n("li",[s._v("预处理:传输一次5QL指令,以后都是执行指令")])])])])]),s._v(" "),n("li",[s._v("安全:有效防止Sα注入(外部通过数据的特殊使用使得SQL的执行方式改变)\n"),n("ul",[n("li",[s._v("普通处理:直接发送给服务器执行(容易岀现SQL注入)")]),s._v(" "),n("li",[s._v("预处理:发送的是结构,数据是后期执行传入(传入协议不一样,数据安全性高)")]),s._v(" "),n("li")])])])])]),s._v(" "),n("p",[n("strong",[s._v("预处理传参")]),s._v(":在执行预处理的时候传入预处理需要的可变数据")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("一般预处理都不会是固定死的SQ指令,而是具有一些数据可变的执行(条件)")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("可变数据的位置使用占位符?占位")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("prepare 预处理名字 from `预处理指令 变化部分使用 ? 替代`\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])])]),s._v(" "),n("li",[n("p",[s._v("在执行预处理的时候将实际数据传进去代替占位符执行SQL")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("数据存储到变量(预处理传入的值必须是变量保存的)")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("set @变量名 = 值;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("使用 using关键字传参")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("execute 预处理名字 using @变量名;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("数据传入的顺序与预处理中占位符的顺序一致")])])])])]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("向t40表中插入数据\n#准备预处理:涉及参数\nprepare t_40_insert from 'insert into t_40 values(null,?,?,?,?)';\n\n#设置变量并传入参数\nset @name='药师兜';\nset @gender='男';\nset @age =23;\nset @class_name='木叶1班';\n\n#执行预处理\nexecute t_40_insert using @name, @gender, @age, @class_name;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);